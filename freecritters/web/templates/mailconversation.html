{% extends "layout.html" %}
{% include "mail_tabs.html" %}
{% block title %}Mail: {{ conversation.subject|e }}{% endblock %}

{% block head %}
<script src="{{ fc.url('static', fn='mailconversation.js')|e }}" type="text/javascript"></script>
{% endblock %}

{% block tabs render_tabs(mail_tabs) %}

{% block content %}

<script type="text/javascript">
var expanded = {{ expanded|jsonencode }};
var collapsed = {{ collapsed|jsonencode }};
</script>

{% if reply_successful %}
<p class="formsuccessful">Replied sucessfully.</p>
{% endif %}

{% if conversation.system %}
<p>This is a system-generated message.</p>
{% else %}
<p id="conversationheader">Conversation between you and 
    {% set first = true -%}
    {%- for participant in conversation.participants -%}
    {%- if participant != participation -%}
    {%- if not first -%}, {% endif -%}
    {%- set first = false -%}
    <a href="{{ fc.url('profile', username=participant.user.unformatted_username)|e }}">{{ participant.user.username|e }}</a>
    {%- endif %}
    {%- endfor -%}
.</p>
{% endif %}

{% if delete_form %}
{{ render_form(delete_form) }}
{% endif %}

{% for message in messages %}
<div class="mailmessage" id="mailmessage{{ message.message_id|e }}">
<p class="mailmessageheader">Sent {{ message.sent|datetime|e }} by <a href="{{ fc.url('profile', username=message.user.unformatted_username)|e }}">{{ message.user.username|e }}</a>{% if reply_form %} &ndash; <a href="{{ fc.url('mail.conversation', conversation_id=conversation.conversation_id, quote=message.message_id)|e }}" onclick="quote('message', {{ message.message|jsonencode|e }}); return false;">quote</a>{% endif %}</p>
<div class="mailmessagebody">{{ message.rendered_message }}</div>
</div>
{% endfor %}

{% if reply_form %}
<h3 id="reply">Reply</h3>
{{ render_form(reply_form) }}
{% endif %}

{% endblock %}